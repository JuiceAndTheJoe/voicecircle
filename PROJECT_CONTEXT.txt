VoiceCircle - Project Context
==============================

Type: Full-stack monorepo (Node.js backend + Vanilla JS frontend)
Platform Target: Eyevinn Open Source Cloud (OSaaS) - *.osaas.io

STRUCTURE
---------
voicecircle/
├── package.json              Root monorepo config
├── backend/                  Node.js/Express backend
│   ├── src/
│   │   ├── index.js          Main server entry (Express, port 3000)
│   │   ├── routes/           API routes (auth, users, posts, rooms, upload, health)
│   │   ├── services/         DB, storage, redis, SMB services
│   │   ├── middleware/       Auth, validation, error handling
│   │   └── controllers/     (empty - route-based approach)
│   ├── package.json
│   ├── .env                  Current config (OSC service URLs)
│   └── .env.example
└── frontend/                 Vanilla JS + Vite
    ├── src/
    │   ├── App.js            Entry point
    │   ├── router.js         Client-side router
    │   ├── pages/            Page components
    │   ├── components/       UI components (Common, Navigation, Posts, Rooms, Users)
    │   ├── services/         API client services
    │   └── styles/           CSS
    ├── package.json
    └── vite.config.js        Dev server proxies /api to backend :3000

TECH STACK
----------
Backend:  Express 4.18.2, Node >=18
Database: Apache CouchDB (4 DBs: users, posts, rooms, relationships)
Cache:    Redis/Valkey (ioredis 5.3.2)
Storage:  MinIO S3-compatible (AWS SDK)
WebRTC:   Symphony Media Bridge (WHIP/WHEP via Eyevinn)
Auth:     JWT (jsonwebtoken 9.0.2), bcryptjs
Frontend: Vanilla JS, Vite 5.0.0 (no framework)

BUILD & RUN
-----------
npm install   -> postinstall: installs backend+frontend deps, builds frontend,
                 copies dist/* to backend/public/
npm start     -> cd backend && npm start (node src/index.js)
Dev:          frontend: npm run dev (Vite :5173), backend: npm run dev (--watch :3000)

Backend serves both API (/api/*) and static frontend from /public with SPA fallback.

OSC SERVICE DEFAULTS (hardcoded in services as fallbacks)
---------------------------------------------------------
CouchDB:  https://team2-voicecircledb.apache-couchdb.auto.prod.osaas.io
          admin / voicecircle2026db

Redis:    redis://172.232.131.169:10522

MinIO S3: https://team2-voicecirclestore.minio-minio.auto.prod.osaas.io
          voicecircleadmin / VoiceCircle2026!

SMB:      https://team2-vcsmb2.eyevinn-docker-wrtc-sfu.auto.prod.osaas.io
WHIP:     https://team2-vcwhip2.eyevinn-smb-whip-bridge.auto.prod.osaas.io
WHEP:     https://team2-vcegress2.eyevinn-wrtc-egress.auto.prod.osaas.io
TURN:     team2-vcturn.srperens-uturn.auto.prod.osaas.io:3478
          voicecircle / voicecircle2024
SMB Key:  voicecircle-api-key-2024

WEBRTC STATUS (2026-02-11): BROKEN - See SMB_analysis.txt for details
  WHIP bridge has upstream library bug preventing publishing

API ROUTES
----------
/api/health   Health check
/api/auth     Login, register
/api/users    User management
/api/posts    Audio/video posts
/api/rooms    Live rooms/conferences
/api/upload   File upload (Multer)

Rate limit: 100 req / 15 min per IP on /api/*

FEATURES
--------
- User auth, profiles, follow system
- Audio/video post recording & playback
- Live WebRTC rooms via Symphony Media Bridge (CURRENTLY BROKEN - upstream bug)
- Redis-based participant tracking
- File upload (avatars, voice messages, video) to MinIO
- Social feed, user search

NO CONTAINERIZATION YET
-----------------------
No Dockerfile, no docker-compose, no Kubernetes config.
Intended for OSC Web Runner deployment (per commit fefdf6e).
Needs Dockerfile or OSC app config to deploy.

ENV VARS (from .env.example / .env)
------------------------------------
PORT, NODE_ENV, FRONTEND_URL, JWT_SECRET
COUCHDB_URL, COUCHDB_USER, COUCHDB_PASSWORD
REDIS_URL
S3_ENDPOINT, S3_ACCESS_KEY, S3_SECRET_KEY, S3_REGION, S3_BUCKET
SMB_URL, SMB_API_KEY, WHIP_URL, WHEP_URL

================================================================================
WEBRTC, WHIP/WHEP & SYMPHONY MEDIA BRIDGE - CONCEPTUAL OVERVIEW
================================================================================

WHAT IS WEBRTC?
---------------
WebRTC (Web Real-Time Communication) is a set of protocols and APIs enabling
peer-to-peer audio, video, and data communication directly in browsers.

Key Components:
  ICE   - NAT traversal, finds network paths between peers
  DTLS  - Encryption key exchange for secure media
  SRTP  - Encrypted media transport (audio/video packets)
  SDP   - Session Description Protocol, negotiates codecs and streams
  SCTP  - Data channels for arbitrary data (chat, file transfer)

Why SFUs Exist:
  Direct peer-to-peer doesn't scale. With N participants, you'd need N×(N-1)
  connections. An SFU (Selective Forwarding Unit) acts as a central hub -
  each participant connects once, the SFU forwards streams intelligently.

WHAT IS SYMPHONY MEDIA BRIDGE (SMB)?
------------------------------------
SMB is an open-source, high-performance media server written in C++ by FINOS.
It handles real-time audio, video, and screen sharing in conference systems.

Architecture: HYBRID SFU/MCU
  - Video: Forwarded without transcoding (pure SFU - low latency)
  - Audio: Can be forwarded OR mixed into single stream (MCU when requested)

Key Capabilities:
  - Supports VP8, H.264 video codecs and Opus audio
  - Video simulcast (multiple quality levels, adaptive forwarding)
  - Dominant speaker detection
  - Bandwidth estimation for quality adaptation
  - Barbell connections for multi-region scaling (link SMB instances)
  - Wait-free concurrent architecture for high performance

SMB Core API:
  POST   /conferences/                        - Create conference
  POST   /conferences/{id}/{endpoint}         - Allocate endpoint (returns SDP)
  PUT    /conferences/{id}/{endpoint}         - Configure endpoint (send SDP answer)
  DELETE /conferences/{id}/{endpoint}         - Remove participant
  GET    /conferences                         - List conferences
  GET    /stats                               - CPU, bitrate, memory metrics

WHAT ARE WHIP AND WHEP?
-----------------------
Standardized HTTP-based protocols for WebRTC signaling (IETF standards).

WHIP (WebRTC-HTTP Ingestion Protocol):
  Purpose: SEND/PUBLISH media TO a server
  Flow:    1. Client sends SDP offer via HTTP POST
           2. Server returns SDP answer
           3. ICE/DTLS handshake completes
           4. Media flows: Client -> Server
  Use:     Broadcaster pushing a live stream

WHEP (WebRTC-HTTP Egress Protocol):
  Purpose: RECEIVE/SUBSCRIBE to media FROM a server
  Flow:    1. Client sends SDP offer via HTTP POST
           2. Server returns SDP answer
           3. ICE/DTLS handshake completes
           4. Media flows: Server -> Client
  Use:     Viewer watching a live stream

Why WHIP/WHEP Matter:
  Before these protocols, every WebRTC service had proprietary signaling.
  WHIP/WHEP create a standard HTTP-based approach, making WebRTC streaming
  interoperable like RTMP was for traditional streaming.

HOW LIVESTREAMING WORKS THROUGH SMB (VoiceCircle Architecture)
---------------------------------------------------------------
VoiceCircle uses BRIDGE SERVICES that abstract SMB complexity:

  ┌─────────────────┐     WHIP      ┌──────────────────┐              ┌─────────────┐
  │  Broadcaster    │──────────────>│  SMB-WHIP-Bridge │──HTTP API──>│     SMB     │
  │  (Browser)      │               │  (Node.js)       │              │   (SFU)     │
  └─────────────────┘               └──────────────────┘              └──────┬──────┘
                                                                             │
                                                                    Forwards streams
                                                                             │
  ┌─────────────────┐     WHEP      ┌──────────────────┐              ┌──────v──────┐
  │    Viewer       │<─────────────│   WRTC-Egress    │<─HTTP API───│     SMB      │
  │  (Browser)      │              │   (Node.js)      │              │   (SFU)      │
  └─────────────────┘              └──────────────────┘              └──────────────┘

Publishing Flow (Host via WHIP):
  1. Browser: getUserMedia() -> get audio/video
  2. Browser: Create RTCPeerConnection with ICE/TURN servers
  3. Browser: Add tracks, create SDP offer
  4. Browser: POST offer to WHIP endpoint /api/v2/whip/sfu-broadcaster
  5. WHIP Bridge: Allocates conference + endpoint in SMB
  6. WHIP Bridge: Returns SDP answer + channelId in Location header
  7. Browser: ICE/DTLS handshake completes
  8. Media flows: Browser -> WHIP Bridge -> SMB

Subscribing Flow (Viewer via WHEP):
  1. Browser: Get channelId from backend
  2. Browser: Create RTCPeerConnection
  3. Browser: POST SDP offer to WHEP /whep/channel/{channelId}
  4. WHEP Egress: Creates subscriber endpoint in SMB
  5. WHEP Egress: Returns SDP answer
  6. Browser: ICE/DTLS handshake completes
  7. Media flows: SMB -> WHEP Egress -> Browser

SERVICES IN USE (VoiceCircle on OSC)
------------------------------------
1. SMB (eyevinn-docker-wrtc-sfu)    - The actual SFU, handles media routing
2. WHIP Bridge (eyevinn-smb-whip-bridge) - Ingress gateway, WHIP -> SMB API
3. WHEP Egress (eyevinn-wrtc-egress)     - Egress gateway, SMB API -> WHEP
4. TURN Server (srperens-uturn)          - NAT traversal relay

CRITICAL CONFIGURATION:
  WHIP Bridge MUST have WhepEndpointUrl configured to register channels
  with WHEP Egress. Without this, published streams are invisible to viewers.

ALTERNATIVE: DIRECT SMB INTEGRATION
-----------------------------------
Instead of WHIP/WHEP bridges, applications can call SMB API directly:
  - More control (custom SSRC assignment, multi-speaker routing)
  - More complex (manual SDP generation, endpoint lifecycle management)
  - Example: Eyevinn Intercom-Manager uses this approach

Comparison:
  WHIP/WHEP Bridges              Direct SMB Integration
  ────────────────────           ──────────────────────
  Simple setup                   Complex setup
  Standard protocols             Custom signaling
  Less control                   Fine-grained control
  Bridge handles SDP             Manual SDP handling
  Easier debugging               Harder debugging

REFERENCES
----------
- SMB GitHub: https://github.com/finos/SymphonyMediaBridge
- SMB WHIP Bridge: https://github.com/Eyevinn/smb-whip-bridge
- WRTC Egress: https://github.com/Eyevinn/wrtc-egress
- WHIP Spec: https://datatracker.ietf.org/doc/draft-ietf-wish-whip/
- WHEP Spec: https://datatracker.ietf.org/doc/draft-ietf-wish-whep/

For VoiceCircle-specific implementation details and current bugs, see:
  smb_analysis.txt
